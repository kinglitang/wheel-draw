<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SVG è½¬ç›˜æŠ½å¥–</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      /* æ¸å˜èƒŒæ™¯ */
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      position: relative;
      min-height: 100vh;
    }

    /* åœ†ç‚¹çº¹ç†æ•ˆæœ */
    body::before {
      content: "";
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      pointer-events: none;
      opacity: 0.15;
      background-image: radial-gradient(circle, #fff 1px, transparent 1.5px);
      background-size: 24px 24px;
      z-index: 0;
    }

    #container {
      position: relative;
      width: 90vw;
      max-width: 400px;
    }

    #pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 25px solid red;
      z-index: 2;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    #wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      background-color: white;
      transition: transform 4s ease-out;
    }

    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      background-color: #28a745;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    button:active {
      background-color: #1e7e34;
    }

    #result {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }

    #history {
      margin-top: 30px;
      width: 100%;
      max-width: 500px;
    }

    #history h3 {
      margin-bottom: 10px;
      font-size: 18px;
    }

    #historyList {
      list-style: disc;
      padding-left: 20px;
      font-size: 16px;
    }

    /* è®©ä¸»è¦å†…å®¹åœ¨åœ†ç‚¹çº¹ç†ä¹‹ä¸Š */
    #container, h2, #result, #history {
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>
  <h2>ğŸ‰ â™¡â™¡å¤§è½¬ç›˜</h2>
  <div id="container">
    <div id="pointer"></div>
    <svg id="wheel" viewBox="0 0 400 400"></svg>
  </div>
  <button id="spinBtn" onclick="spin()">å¼€å§‹æŠ½å¥–</button>
  <div id="chance" style="margin-top:10px;font-size:16px;color:#555;"></div>
  <div id="result"></div>
  <div id="history">
    <h3>æŠ½å¥–å†å²ï¼š</h3>
    <ul id="historyList"></ul>
  </div>

  <script>
    // âœ… å¥–é¡¹æ•°ç»„ï¼ˆ10ä¸ªå¥–é¡¹ï¼‰
    const prizes = [
      { name: "çœ‹ç”µå½±", probability: 0.05 },
      { name: "åƒbigæŠ«è¨", probability: 0.1 },
      { name: "è°¢è°¢å‚ä¸", probability: 0.05 },
      { name: "æ¸¸ä¹åœºä¸€æ—¥æ¸¸", probability: 0.05 },
      { name: "è°¢è°¢å‚ä¸", probability: 0.05 },
      { name: "æ‹æ‹ç«‹å¾—", probability: 0.1 },
      { name: "å°è·åŒ…ä¸€å¤©ä½¿ç”¨æƒ", probability: 0.1 },
      { name: "50å…ƒçº¢åŒ…", probability: 0.1 },
      { name: "ä¹°è›‹ç³•", probability: 0.1 },
      { name: "è°¢è°¢å‚ä¸", probability: 0.05 },
      { name: "åƒäº‘è´µå·", probability: 0.1 },
      { name: "å»æ²ˆé˜³ç©ä¸€å¤©", probability: 0.05 },
      { name: "è°¢è°¢å‚ä¸", probability: 0.05 },
      { name: "ä»»æ„è¦æ±‚ä¸€æ¬¡", probability: 0.05 }
    ];

    // è®°å½•åŸå§‹æ¦‚ç‡
    const originalProbabilities = prizes.map(p => p.probability);
    let isFirstSpin = true;

    function boostFirstPrize(prizes, originalProbabilities, prizeName, boostValue) {
      const targetIndex = prizes.findIndex(p => p.name === prizeName);
      if (targetIndex !== -1) {
        prizes[targetIndex].probability = boostValue;
        const remainProb = 1 - boostValue;
        let sumOther = 0;
        prizes.forEach((p, i) => {
          if (i !== targetIndex) sumOther += originalProbabilities[i];
        });
        prizes.forEach((p, i) => {
          if (i !== targetIndex) {
            p.probability = originalProbabilities[i] / sumOther * remainProb;
          }
        });
      }
    }

    function restoreProbabilities(prizes, originalProbabilities) {
      prizes.forEach((p, i) => {
        p.probability = originalProbabilities[i];
      });
    }

    let currentRotation = 0; // è®°å½•å½“å‰è½¬ç›˜è§’åº¦

    const svg = document.getElementById("wheel");
    const result = document.getElementById("result");
    const historyList = document.getElementById("historyList");

    // å¯åå°ä¿®æ”¹æŠ½å¥–æ¬¡æ•°
    let maxChance = 2; // é»˜è®¤1æ¬¡ï¼Œå¯åå°ä¿®æ”¹

    // ç®€å•èº«ä»½è¯†åˆ«ï¼šæœ¬åœ°ç”Ÿæˆ userId
    function getUserId() {
      let uid = localStorage.getItem('wheel_user_id');
      if (!uid) {
        uid = 'u_' + Math.random().toString(36).slice(2) + Date.now();
        localStorage.setItem('wheel_user_id', uid);
      }
      return uid;
    }
    const userId = getUserId();

    // è¯»å–/ä¿å­˜æŠ½å¥–æ¬¡æ•°
    function getUserChance() {
      const val = localStorage.getItem('wheel_chance_' + userId);
      if (val === null) {
        localStorage.setItem('wheel_chance_' + userId, maxChance);
        return maxChance;
      }
      return parseInt(val, 10);
    }
    function setUserChance(val) {
      localStorage.setItem('wheel_chance_' + userId, val);
    }

    let chance = getUserChance();

    const spinBtn = document.getElementById("spinBtn");
    const chanceDiv = document.getElementById("chance");

    function drawWheel() {
      svg.innerHTML = '';
      const total = prizes.length;
      const anglePer = 360 / total;
      const radius = 200;
      const centerX = 200;
      const centerY = 200;

      prizes.forEach((prize, i) => {
        const startAngle = i * anglePer;
        const endAngle = startAngle + anglePer;
        const largeArc = anglePer > 180 ? 1 : 0;

        const x1 = centerX + radius * Math.cos((startAngle - 90) * Math.PI / 180);
        const y1 = centerY + radius * Math.sin((startAngle - 90) * Math.PI / 180);
        const x2 = centerX + radius * Math.cos((endAngle - 90) * Math.PI / 180);
        const y2 = centerY + radius * Math.sin((endAngle - 90) * Math.PI / 180);

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const color = `hsl(${i * (360 / total)}, 80%, 85%)`;
        path.setAttribute("d",
          `M${centerX},${centerY} L${x1},${y1} A${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z`);
        path.setAttribute("fill", color);
        svg.appendChild(path);

        // æ·»åŠ æ–‡å­—
        const textAngle = (startAngle + endAngle) / 2;
        const textX = centerX + (radius * 0.6) * Math.cos((textAngle - 90) * Math.PI / 180);
        const textY = centerY + (radius * 0.6) * Math.sin((textAngle - 90) * Math.PI / 180);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", textX);
        text.setAttribute("y", textY);
        text.setAttribute("fill", "#333");
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("alignment-baseline", "middle");

        // è‡ªåŠ¨åˆ†è¡Œï¼Œæ¯è¡Œæœ€å¤š6ä¸ªå­—
        const maxLen = 6;
        const lines = [];
        for (let j = 0; j < prize.name.length; j += maxLen) {
          lines.push(prize.name.slice(j, j + maxLen));
        }
        // å­—ä½“å¤§å°æ ¹æ®è¡Œæ•°è°ƒæ•´
        const fontSize = lines.length > 1 ? 11 : 12;
        text.setAttribute("font-size", fontSize);

        // çºµå‘å±…ä¸­
        const lineHeight = fontSize + 2;
        const totalHeight = lineHeight * lines.length;
        lines.forEach((line, idx) => {
          const tspan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
          tspan.setAttribute("x", textX);
          tspan.setAttribute("y", textY - totalHeight / 2 + lineHeight * (idx + 0.5));
          tspan.textContent = line;
          // æ²¿åœ†çš„æ³•å‘æ—‹è½¬
          tspan.setAttribute("transform", `rotate(${textAngle}, ${textX}, ${textY - totalHeight / 2 + lineHeight * (idx + 0.5)})`);
          text.appendChild(tspan);
        });
        svg.appendChild(text);
      });

      // ä¸­å¿ƒåœ†ç‚¹
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", centerX);
      circle.setAttribute("cy", centerY);
      circle.setAttribute("r", 10);
      circle.setAttribute("fill", "#333");
      svg.appendChild(circle);
    }

    function choosePrize() {
      const totalProb = prizes.reduce((sum, p) => sum + p.probability, 0);
      const rand = Math.random() * totalProb;
      let cumulative = 0;
      for (const prize of prizes) {
        cumulative += prize.probability;
        if (rand <= cumulative) return prize;
      }
      return prizes[prizes.length - 1];
    }

    function updateChanceDisplay() {
      chanceDiv.innerText = `å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š${chance}`;
      spinBtn.disabled = chance <= 0;
      spinBtn.style.opacity = chance <= 0 ? 0.5 : 1;
      spinBtn.style.cursor = chance <= 0 ? "not-allowed" : "pointer";
    }

    function spin() {
      if (chance <= 0) {
        alert("è¯·è”ç³»ç…®å•µè·å–æ¬¡æ•°");
        return;
      }

      // ç¬¬ä¸€æ¬¡æŠ½å¥–æ¦‚ç‡æå‡
      if (isFirstSpin) {
        boostFirstPrize(prizes, originalProbabilities, "è°¢è°¢å‚ä¸", 1);
      }

      chance--;
      setUserChance(chance);
      updateChanceDisplay();

      const selected = choosePrize();
      const index = prizes.findIndex(p => p.name === selected.name);
      const anglePer = 360 / prizes.length;
      const targetAngle = 360 - (index * anglePer + anglePer / 2); // æŒ‡é’ˆæŒ‡å‘è§’åº¦

      // è®¡ç®—éœ€è¦æ—‹è½¬åˆ°çš„æœ€ç»ˆè§’åº¦ï¼ˆå¤šè½¬å‡ åœˆï¼Œä¸”ä»å½“å‰è§’åº¦å‡ºå‘ï¼‰
      const rotateRounds = 5; // å›ºå®šè½¬5åœˆ
      const finalRotation = currentRotation + (rotateRounds * 360) + (targetAngle - (currentRotation % 360));

      svg.style.transition = "transform 4s cubic-bezier(0.25, 1, 0.5, 1)";
      svg.style.transform = `rotate(${finalRotation}deg)`;

      currentRotation = finalRotation; // æ›´æ–°å½“å‰è§’åº¦

      setTimeout(() => {
        result.innerText = `ğŸ æ­å–œä½ æŠ½ä¸­äº†ï¼š${selected.name}`;
        alert(`ğŸ æ­å–œä½ æŠ½ä¸­äº†ï¼š${selected.name}`);
        const li = document.createElement("li");
        li.textContent = selected.name;
        historyList.appendChild(li);
      }, 4000);

      // æ¢å¤åŸå§‹æ¦‚ç‡
      if (isFirstSpin) {
        restoreProbabilities(prizes, originalProbabilities);
        isFirstSpin = false;
      }
    }

    drawWheel();
    updateChanceDisplay();

    // åå°å¯é€šè¿‡ maxChance å˜é‡ä¿®æ”¹æŠ½å¥–æ¬¡æ•°
    // ä¾‹å¦‚ï¼šmaxChance = 3; chance = maxChance; setUserChance(chance); updateChanceDisplay();
  </script>
</body>
</html>